<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <link rel="stylesheet" href="{{ .AppBasePath }}/assets/app.css">
    <title>Admin Dashboard - WhatsApp API {{ .AppVersion }}</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>

<body class="admin-body">
    <div class="ui container" id="app" style="padding-top: 20px;">
        <div class="main-header" style="margin-bottom: 30px;">
            <h1 class="ui header center aligned">
                <div class="content">
                    Dashboard Admin Rest API
                    <div class="sub header">Manage your WhatsApp Agents</div>
                </div>
            </h1>
        </div>

        <div class="ui segment">
            <div class="ui relaxed divided list">
                <table class="ui celled table">
                    <thead>
                        <tr>
                            <th>User-Id</th>
                            <th>Agent-Name</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="session in sessions" :key="session.agent_id">
                            <td>[[ session.user_id ]]</td>
                            <td>[[ session.agent_name ]]</td>
                            <td>
                                <div class="ui label" :class="getStatusClass(session.status)">
                                    [[ session.status ]]
                                </div>
                            </td>
                            <td>
                                <button class="ui blue tiny button" @click="editSession(session)">
                                    <i class="edit icon"></i> Edit
                                </button>
                                <button class="ui red tiny button" @click="deleteSession(session)">
                                    <i class="trash icon"></i> Hapus
                                </button>
                            </td>
                        </tr>
                        <tr v-if="sessions.length === 0">
                            <td colspan="4" class="center aligned">No sessions found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        window.showErrorInfo = (message) => {
            $('body').toast({
                position: 'bottom right',
                title: 'Error',
                message: message,
                showProgress: 'bottom',
                classProgress: 'red'
            });
        }
        window.showSuccessInfo = (message) => {
            $('body').toast({
                position: 'bottom right',
                title: 'Success',
                message: message,
                showProgress: 'bottom',
                classProgress: 'green'
            });
        }
        window.http = axios.create({
            baseURL: `${window.location.protocol}//${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}{{ .AppBasePath }}`
        });
    </script>
    {{ if isEnableBasicAuth .BasicAuthToken }}
    <script>
        window.http.defaults.headers.common['Authorization'] = "{{ .BasicAuthToken }}";
    </script>
    {{ end }}
    <script type="module">
        const app = Vue.createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    sessions: []
                }
            },
            methods: {
                async fetchSessions() {
                    try {
                        const response = await window.http.get('/sessions');
                        this.sessions = response.data || [];
                    } catch (error) {
                        console.error('Error fetching sessions:', error);
                        window.showErrorInfo('Failed to fetch sessions');
                    }
                },
                getStatusClass(status) {
                    switch (status) {
                        case 'connected': return 'green';
                        case 'authenticated': return 'blue';
                        case 'disconnected': return 'red';
                        default: return 'grey';
                    }
                },
                editSession(session) {
                    // Placeholder for edit functionality
                    console.log('Edit session:', session);
                    window.showSuccessInfo('Edit feature coming soon for ' + session.agent_name);
                },
                async deleteSession(session) {
                    if (!confirm('Are you sure you want to delete session for ' + session.agent_name + '? This will remove storage files and database records.')) {
                        return;
                    }

                    try {
                        await window.http.delete(`/sessions/${session.agent_id}`);
                        window.showSuccessInfo('Session deleted successfully');
                        this.fetchSessions(); // Refresh list
                    } catch (error) {
                        console.error('Error deleting session:', error);
                        window.showErrorInfo('Failed to delete session: ' + (error.response?.data?.error?.message || error.message));
                    }
                }
            },
            mounted() {
                this.fetchSessions();
            }
        });

        app.mount('#app');
    </script>
</body>

</html>